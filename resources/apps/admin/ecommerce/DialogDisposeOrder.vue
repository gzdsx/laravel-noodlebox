<template>
    <div>
        <el-dialog
            :title="$t('order.dispose')"
            width="75%"
            :visible="value"
            :close-on-click-modal="false"
            :close-on-press-escape="false"
            append-to-body
            closeable
            @close="close"
        >
            <el-row :gutter="20" type="flex">
                <el-col :span="12">
                    <el-form label-width="160px" size="medium" v-loading="loading">
                        <el-form-item :label="$t('order.shipping_address')">
                            <div style="line-height: 1.4; padding-top:8px;">
                                <div>{{ shipping.first_name }}</div>
                                <div>{{ shipping.address_line_1 }}</div>
                                <div v-if="shipping.county">{{ shipping.county }}</div>
                                <div v-if="shipping.city">{{ shipping.city }}</div>
                                <div v-if="shipping.state">{{ shipping.state }}</div>
                                <div v-if="shipping.phone">
                                    <span>+{{ shipping.phone.national_number }}</span>
                                    <span>{{ shipping.phone.phone_number }}</span>
                                </div>
                            </div>
                        </el-form-item>
                        <el-form-item :label="$t('order.shipping_method')">
                            <el-select
                                size="medium"
                                class="w300"
                                v-model="shipping_line.method_id"
                                @change="onShippingMethodChange"
                            >
                                <el-option
                                    v-for="(v,k) in shippingMethodList"
                                    :label="v"
                                    :value="k"
                                    :key="k"
                                />
                            </el-select>
                        </el-form-item>
                        <el-form-item :label="$t('order.shipping_zone')" v-if="shipping_line.method_id==='flat_rate'">
                            <el-select
                                size="medium"
                                class="w300"
                                v-model="shippingZoneIndex"
                                @change="onShippingMethodChange"
                            >
                                <el-option
                                    v-for="(v,k) in shippingZones"
                                    :label="v.title+'(â‚¬'+v.fee+')'"
                                    :value="k"
                                    :key="k"
                                />
                            </el-select>
                        </el-form-item>
                        <el-form-item :label="$t('order.deliveryer')" v-if="shipping_line.method_id==='flat_rate'">
                            <el-select size="medium" class="w300" v-model="order.deliveryer_id">
                                <el-option
                                    v-for="(v,k) in deliveryerList"
                                    :label="v.name"
                                    :value="v.id"
                                    :key="k"
                                />
                            </el-select>
                        </el-form-item>
                        <el-form-item :label="$t('order.order_status')">
                            <el-select size="medium" class="w300" v-model="order.status">
                                <el-option
                                    v-for="(v,k) in statusList"
                                    :label="v"
                                    :value="k"
                                    :key="k"
                                />
                            </el-select>
                        </el-form-item>
                        <el-form-item :label="$t('order.order_total')">
                            <el-input
                                class="w300"
                                type="number"
                                :value="orderTotal"
                            />
                        </el-form-item>
                        <el-form-item label="Cost Fee">
                            <div class="d-flex">
                                <el-input
                                    class="w300"
                                    type="number"
                                    v-model="order.cost_total"
                                />
                            </div>
                        </el-form-item>
                        <el-form-item :label="$t('order.payment_method')">
                            <el-select
                                size="medium"
                                class="w300"
                                v-model="payment_method"
                                @change="onShippingMethodChange"
                                :disabled="order.payment_method==='online'"
                            >
                                <el-option
                                    v-for="(v,k) in paymentMethodList"
                                    :label="v.title"
                                    :value="v.id"
                                    :key="k"
                                    :disabled="v.id==='online'"
                                />
                            </el-select>
                        </el-form-item>
                        <el-form-item v-if="payment_method==='customize'">
                            <el-input
                                class="w200"
                                v-model="meta_data.payment_with_cash_value"
                            >
                                <span slot="prepend">By Cash</span>
                            </el-input>
                            <el-input class="w200" :value="payByCardValue" readonly>
                                <span slot="prepend">By Card</span>
                            </el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="onSubmit">{{ $t('common.submit') }}</el-button>
                        </el-form-item>
                    </el-form>
                </el-col>
                <el-col :span="12">
                    <div>Customer Notes</div>
                    <el-input
                        type="textarea"
                        class="w500"
                        :rows="3"
                        v-model="order.buyer_note"
                    />

                    <div style="margin:10px 0;">Order Logs</div>
                    <el-timeline>
                        <el-timeline-item
                            v-for="(note, index) in order_notes"
                            :key="index"
                            :timestamp="note.created_at"
                        >
                            <div class="el-timeline-item__content" v-html="note.content"></div>
                        </el-timeline-item>
                    </el-timeline>
                </el-col>
            </el-row>
        </el-dialog>
    </div>
</template>

<script>
import ApiService from "../utils/ApiService";

export default {
    name: "DialogDisposeOrder",
    props: {
        value: {
            type: Boolean,
            default: false
        },
        order: {
            type: Object,
            default() {
                return {
                    status: 'pending',
                    deliveryer_id: ''
                }
            }
        }
    },
    data() {
        return {
            loading: false,
            statusList: [],
            deliveryerList: [
                {
                    id: 0,
                    name: 'Please Select'
                }
            ],
            disposeData: {
                status: 'pending',
                deliveryer_id: ''
            },
            paymentMethodList: [
                {
                    id: 'online',
                    title: 'Pay Online (PayPal & Credit Car)',
                    fee: 0.5,
                },
                {
                    id: 'card',
                    title: 'Pay by Card Reader',
                    fee: 0.5,
                },
                {
                    id: 'cash',
                    title: 'Pay Cash',
                    fee: 0.0,
                },
                {
                    id: 'customize',
                    title: 'Customize',
                    fee: 0.0,
                }
            ],
            shippingMethodList: {
                'flat_rate': 'Delivery',
                'local_pickup': 'Collection',
            },
            shippingZones: [],
            shippingZoneIndex: 0,
            shipping: {},
            shipping_line: {
                method_id: 'local_pickup',
                method_title: 'Collection',
                total: '0.00',
                taxes: [],
                zone_id: 0,
                zone_title: ''
            },
            meta_data: {
                cost_total: 0,
                payment_with_cash_value: 0
            },
            order_notes: [],
            orderTotal: 0,
            payment_method: 'online',
        }
    },
    computed: {
        payByCardValue() {
            return (this.orderTotal - this.meta_data.payment_with_cash_value).toFixed(2);
        },
    },
    watch: {
        value(val) {
            if (val) {
                this.fetchOrderNotes();
                let {shipping, shipping_line, meta_data, total} = this.order;
                this.shipping = shipping || {};
                this.shipping_line = {
                    ...this.shipping_line,
                    ...shipping_line
                }
                this.meta_data = {
                    ...this.meta_data,
                    ...meta_data,
                }

                if (shipping_line.zone_id > 0) {
                    this.shippingZoneIndex = this.shippingZones.findIndex(item => item.id === shipping_line.zone_id);
                }

                this.payment_method = this.order.payment_method || 'online';

                this.orderTotal = total;
                this.costTotal = this.meta_data.cost_total;
            }
        },
    },
    methods: {
        close() {
            this.$emit('input', false);
        },
        fetchStatusList() {
            this.$get('/orders/options').then(response => {
                this.statusList = response.data.status_options;
            });
        },
        fetchDeliveryerList() {
            this.$get('/deliveryers?limit=100').then(response => {
                this.deliveryerList = this.deliveryerList.concat(response.data.items);
            });
        },
        fetchShippingZones() {
            this.$get('/shipping-zones').then(response => {
                this.shippingZones = response.data.items;
            });
        },
        fetchOrderNotes() {
            this.$get(`/orders/${this.order.id}/notes`).then(response => {
                this.order_notes = response.data.items;
            });
        },
        onSubmit() {
            let {
                id,
                status,
                buyer_note,
                deliveryer_id,
                cost_total
            } = this.order;
            let {shipping_line, orderTotal, payByCardValue, payment_method} = this;
            let payment_method_title = this.paymentMethodList.filter(item => item.id === payment_method)[0].title;
            let meta_data = {
                ...this.meta_data,
                payment_with_card_value: payByCardValue,
            };

            this.loading = true;
            ApiService.put(`/orders/${id}`, {
                cost_total,
                shipping_line,
                payment_method,
                payment_method_title,
                deliveryer_id,
                buyer_note,
                meta_data,
                status,
                total: orderTotal,
            }).then(() => {
                this.$message.success('Order Updated!');
                this.$emit('update');
            }).finally(() => {
                this.loading = false;
                this.$emit('input', false);
            });
        },
        subTotal(item) {
            return item.price * item.quantity;
        },
        onShippingMethodChange() {
            let {total, shipping_total} = this.order;
            let cost_total = this.meta_data.cost_total || 0;
            if (this.shipping_line.method_id === 'flat_rate') {
                let zone = this.shippingZones[this.shippingZoneIndex];
                if (zone) {
                    this.shipping_line = {
                        method_id: 'flat_rate',
                        method_title: 'Delivery',
                        total: zone.fee,
                        zone_id: zone.id,
                        zone_title: zone.title,
                    }
                }
            } else {
                this.shipping_line = {
                    method_id: 'local_pickup',
                    method_title: 'Collection',
                    total: 0,
                    zone_id: 0,
                    zone_title: '',
                }
            }

            let diference = Number(this.shipping_line.total) - Number(shipping_total);
            if (this.order.payment_method === 'online') {
                this.costTotal = (Number(cost_total) + Number(diference)).toFixed(2);
            } else {
                this.orderTotal = (Number(total) + Number(diference)).toFixed(2);
            }
        }
    },
    mounted() {
        this.fetchStatusList();
        this.fetchDeliveryerList();
        this.fetchShippingZones();
    },
}
</script>

<style scoped>

</style>